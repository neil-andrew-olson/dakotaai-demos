<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dakota AI Demos - Real-Time Stock Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        #stockInput { display: block; margin: 20px auto; padding: 10px; width: 200px; }
        #stockData { margin-top: 20px; }
        #toggles { text-align: center; margin: 10px 0; }
        #callCount { color: red; font-weight: bold; }
        #atrInfo { margin-top: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 5px; }
        canvas { display: block; margin: 20px auto; width: 80vw; height: 50vh; max-width: 800px; max-height: 400px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dakota AI Demo: Real-Time Stock Price Tracker</h1>
        <p>This demo showcases our capabilities in real-time data processing, analytics, and visualization. Enter a stock symbol (e.g., AAPL) to fetch real-time data and analyze trends.</p>
        <input type="text" id="stockInput" placeholder="Enter Stock Symbol" value="AAPL">
        <button onclick="fetchStockData()">Fetch Data</button>
        <p id="callCount">API calls today: 0/25</p>
        <div id="toggles">
            <label><input type="checkbox" id="smaToggle" checked> Show SMA (20)</label>
            <label><input type="checkbox" id="ema8Toggle"> Show EMA (8)</label>
            <label><input type="checkbox" id="ema13Toggle"> Show EMA (13)</label>
            <label><input type="checkbox" id="ema21Toggle"> Show EMA (21)</label>
            <label><input type="checkbox" id="ema34Toggle"> Show EMA (34)</label>
            <label><input type="checkbox" id="ema50Toggle"> Show EMA (50)</label>
            <label><input type="checkbox" id="rsiToggle"> Show RSI</label>
            <label><input type="checkbox" id="atrToggle" checked> Show ATR Levels</label>
        </div>
        <div id="stockData"></div>
        <canvas id="myChart"></canvas>
    </div>

    <script>
        let chart;
        let dataCache = null;

        function updateCallCount() {
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem('lastCallDate');
            let callsToday = parseInt(localStorage.getItem('callsToday') || 0);
            if (lastDate !== today) {
                callsToday = 0;
                localStorage.setItem('lastCallDate', today);
            }
            document.getElementById('callCount').textContent = `API calls today: ${callsToday}/25`;
            return callsToday;
        }

        function incrementCallCount() {
            const callsToday = updateCallCount() + 1;
            localStorage.setItem('callsToday', callsToday);
            updateCallCount();
        }

        function calculateEMA(prices, period) {
            const multiplier = 2 / (period + 1);
            const ema = [];
            let prev = prices[0];
            for (let i = 0; i < prices.length; i++) {
                prev = (prices[i] - prev) * multiplier + prev;
                ema.push(prev);
            }
            return ema;
        }

        function calculateRSI(prices, period = 14) {
            const gains = [];
            const losses = [];
            for (let i = 1; i < prices.length; i++) {
                const change = prices[i] - prices[i-1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? -change : 0);
            }
            const rsi = [];
            let avgGain = gains.slice(0, period).reduce((a,b)=>a+b,0) / period;
            let avgLoss = losses.slice(0, period).reduce((a,b)=>a+b,0) / period;
            for (let i = 0; i < gains.length; i++) {
                if (i >= period) {
                    avgGain = (avgGain * (period - 1) + gains[i]) / period;
                    avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                }
                const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                rsi.push(100 - (100 / (1 + rs)));
            }
            return Array(period).fill(null).concat(rsi);
        }

        function calculateATR(highs, lows, closes, period = 14) {
            const tr = [];
            for (let i = 0; i < highs.length; i++) {
                if (i === 0) {
                    tr.push(highs[i] - lows[i]);
                } else {
                    const tr1 = highs[i] - lows[i];
                    const tr2 = Math.abs(highs[i] - closes[i-1]);
                    const tr3 = Math.abs(lows[i] - closes[i-1]);
                    tr.push(Math.max(tr1, tr2, tr3));
                }
            }
            const atr = [];
            let sum = tr.slice(0, period).reduce((a, b) => a + b, 0);
            atr.push(sum / period);
            for (let i = period; i < tr.length; i++) {
                atr.push((atr[atr.length - 1] * (period - 1) + tr[i]) / period);
            }
            return atr;
        }

        function calculateATRLevels(previousClose, atr, highs, lows) {
            const range = Math.max(...highs) - Math.min(...lows);
            const trPercentOfATR = range / atr * 100;

            const lowerTrigger = previousClose - 0.236 * atr;
            const upperTrigger = previousClose + 0.236 * atr;

            const levels = {
                previousClose: previousClose,
                lowerTrigger: lowerTrigger,
                upperTrigger: upperTrigger,
                lower0382: previousClose - 0.382 * atr,
                upper0382: previousClose + 0.382 * atr,
                lower0500: previousClose - 0.5 * atr,
                upper0500: previousClose + 0.5 * atr,
                lower0618: previousClose - 0.618 * atr,
                upper0618: previousClose + 0.618 * atr,
                lower0786: previousClose - 0.786 * atr,
                upper0786: previousClose + 0.786 * atr,
                lower1000: previousClose - atr,
                upper1000: previousClose + atr,
                lower1236: previousClose - 1.236 * atr,
                upper1236: previousClose + 1.236 * atr,
                lower1382: previousClose - 1.382 * atr,
                upper1382: previousClose + 1.382 * atr,
                lower1500: previousClose - 1.5 * atr,
                upper1500: previousClose + 1.5 * atr,
                lower1618: previousClose - 1.618 * atr,
                upper1618: previousClose + 1.618 * atr,
                lower1786: previousClose - 1.786 * atr,
                upper1786: previousClose + 1.786 * atr,
                lower2000: previousClose - 2 * atr,
                upper2000: previousClose + 2 * atr
            };

            return { levels, trPercentOfATR, range };
        }

        function determineTrend(price, fastEMA, pivotEMA, slowEMA) {
            const bullish = price >= fastEMA && fastEMA >= pivotEMA && pivotEMA >= slowEMA;
            const bearish = price <= fastEMA && fastEMA <= pivotEMA && pivotEMA <= slowEMA;
            return bullish ? 'Bullish' : bearish ? 'Bearish' : 'Neutral';
        }

        function renderChart(times, prices, sma, ema8, ema13, ema21, ema34, ema50, rsi, atrLevels) {
            const ctx = document.getElementById('myChart');
            const datasets = [{
                label: 'Price',
                data: prices,
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }];

            if (document.getElementById('smaToggle').checked && sma) datasets.push({
                label: 'SMA (20)',
                data: sma,
                borderColor: '#F44336',
                borderWidth: 1,
                fill: false,
                borderDash: [5, 5],
                pointRadius: 0
            });

            if (document.getElementById('ema8Toggle').checked && ema8) datasets.push({
                label: 'EMA (8)',
                data: ema8,
                borderColor: '#4CAF50',
                borderWidth: 1,
                fill: false,
                pointRadius: 0
            });

            if (document.getElementById('ema13Toggle').checked && ema13) datasets.push({
                label: 'EMA (13)',
                data: ema13,
                borderColor: '#FF9800',
                borderWidth: 1,
                fill: false,
                pointRadius: 0
            });

            if (document.getElementById('ema21Toggle').checked && ema21) datasets.push({
                label: 'EMA (21)',
                data: ema21,
                borderColor: '#9C27B0',
                borderWidth: 1,
                fill: false,
                pointRadius: 0
            });

            if (document.getElementById('ema34Toggle').checked && ema34) datasets.push({
                label: 'EMA (34)',
                data: ema34,
                borderColor: '#00BCD4',
                borderWidth: 1,
                fill: false,
                pointRadius: 0
            });

            if (document.getElementById('ema50Toggle').checked && ema50) datasets.push({
                label: 'EMA (50)',
                data: ema50,
                borderColor: '#795548',
                borderWidth: 1,
                fill: false,
                pointRadius: 0
            });

            // Add ATR levels as horizontal lines
            if (document.getElementById('atrToggle').checked && atrLevels) {
                const chartLength = prices.length;
                datasets.push({
                    label: 'Previous Close',
                    data: new Array(chartLength).fill(atrLevels.previousClose),
                    borderColor: '#424242',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                });
                datasets.push({
                    label: 'Lower Trigger',
                    data: new Array(chartLength).fill(atrLevels.lowerTrigger),
                    borderColor: '#FFC107',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                });
                datasets.push({
                    label: 'Upper Trigger',
                    data: new Array(chartLength).fill(atrLevels.upperTrigger),
                    borderColor: '#00BCD4',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                });
                datasets.push({
                    label: 'ATR -1',
                    data: new Array(chartLength).fill(atrLevels.lower1000),
                    borderColor: '#FF5722',
                    borderWidth: 1,
                    borderDash: [10, 5],
                    pointRadius: 0,
                    fill: false
                });
                datasets.push({
                    label: 'ATR +1',
                    data: new Array(chartLength).fill(atrLevels.upper1000),
                    borderColor: '#4CAF50',
                    borderWidth: 1,
                    borderDash: [10, 5],
                    pointRadius: 0,
                    fill: false
                });
            }

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: times.map(t => new Date(t).toLocaleTimeString()), datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                afterBody: function(context) {
                                    let tooltipText = [];
                                    if (rsi && rsi[context[0].dataIndex]) {
                                        tooltipText.push('RSI: ' + rsi[context[0].dataIndex].toFixed(2));
                                    }
                                    return tooltipText;
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 0,
                            hoverRadius: 4
                        }
                    }
                }
            });
        }

        async function fetchStockData() {
            let callsToday = updateCallCount();
            if (callsToday >= 25) {
                document.getElementById('stockData').innerHTML = 'Daily API limit reached (25 calls). Try again tomorrow.';
                return;
            }

            const symbol = document.getElementById('stockInput').value.toUpperCase();
            const apiKey = '1KVB3JGWTYYBEYDS'; // Note: This should be kept secret; move to server-side for production
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=${symbol}&interval=5min&apikey=${apiKey}`;

            try {
                document.getElementById('stockData').innerHTML = 'Fetching data...';
                const response = await axios.get(url);
                const data = response.data['Time Series (5min)'];
                incrementCallCount();

                if (!data) {
                    document.getElementById('stockData').innerHTML = 'Invalid symbol or API error.';
                    return;
                }

                const times = Object.keys(data).reverse();
                const opens = times.map(time => parseFloat(data[time]['1. open']));
                const highs = times.map(time => parseFloat(data[time]['2. high']));
                const lows = times.map(time => parseFloat(data[time]['3. low']));
                const closes = times.map(time => parseFloat(data[time]['4. close']));
                const volumes = times.map(time => parseFloat(data[time]['5. volume']));
                const prices = opens; // Using opens as primary price

                // Calculations
                const sma = prices.map((price, index) => {
                    if (index < 19) return null;
                    const sum = prices.slice(index - 19, index + 1).reduce((a, b) => a + b, 0);
                    return sum / 20;
                });
                const ema8 = calculateEMA(prices, 8);
                const ema13 = calculateEMA(prices, 13);
                const ema21 = calculateEMA(prices, 21);
                const ema34 = calculateEMA(prices, 34);
                const ema50 = calculateEMA(prices, 50);
                const rsi = calculateRSI(closes, 14);
                const atr = calculateATR(highs, lows, closes, 14);
                const previousClose = closes[closes.length - 1];
                const latestATR = atr[atr.length - 1];

                // Calculate range for current session (last ~24 hours of data, roughly one trading session)
                const sessionLength = Math.min(closes.length, Math.floor(closes.length * 0.8)); // Use ~80% of available data for current session
                const sessionHighs = highs.slice(-sessionLength);
                const sessionLows = lows.slice(-sessionLength);
                const sessionRange = Math.max(...sessionHighs) - Math.min(...sessionLows);

                const { levels: atrLevels, trPercentOfATR } = calculateATRLevels(previousClose, latestATR, sessionHighs, sessionLows);

                // Trend calculation
                const trend = determineTrend(closes[closes.length - 1], ema8[ema8.length - 1], ema21[ema21.length - 1], ema34[ema34.length - 1]);

                dataCache = {
                    times, prices, sma, ema8, ema13, ema21, ema34, ema50, rsi, atr,
                    atrLevels, trPercentOfATR, range: sessionRange, trend, highs, lows, closes, volumes
                };

                // Update UI
                const latestPrice = prices[prices.length - 1];
                const latestTime = times[times.length - 1];
                const latestRsi = rsi[rsi.length - 1];

                let atrInfoHTML = '';
                if (document.getElementById('atrToggle').checked) {
                    const trColor = trPercentOfATR <= 70 ? 'green' : trPercentOfATR >= 90 ? 'red' : 'orange';
                    atrInfoHTML = `
                        <div id="atrInfo">
                            <h3>Saty ATR Levels</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="background-color: ${trend === 'Bullish' ? '#d4edda' : trend === 'Bearish' ? '#f8d7da' : '#fff3cd'};">
                                    <td><strong>Trend:</strong> ${trend}</td>
                                    <td><strong>Range ($${dataCache.range.toFixed(2)}) is ${trPercentOfATR.toFixed(1)}% of ATR ($${latestATR.toFixed(2)})</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Calls > $${atrLevels.upperTrigger.toFixed(2)}</strong></td>
                                    <td><strong>+1 ATR: $${atrLevels.upper1000.toFixed(2)}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Puts < $${atrLevels.lowerTrigger.toFixed(2)}</strong></td>
                                    <td><strong>-1 ATR: $${atrLevels.lower1000.toFixed(2)}</strong></td>
                                </tr>
                            </table>
                        </div>
                    `;
                }

                // Create EMA display text
                let emaDisplay = '';
                const emaInfo = [
                    { period: 8, value: ema8[ema8.length - 1] },
                    { period: 13, value: ema13[ema13.length - 1] },
                    { period: 21, value: ema21[ema21.length - 1] },
                    { period: 34, value: ema34[ema34.length - 1] },
                    { period: 50, value: ema50[ema50.length - 1] }
                ];

                emaDisplay = emaInfo.map(ema => `<p><strong>EMA (${ema.period}):</strong> $${ema.value.toFixed(2)}</p>`).join('');

                document.getElementById('stockData').innerHTML = `
                    <h2>${symbol} - Latest Data</h2>
                    <p><strong>Time:</strong> ${latestTime}</p>
                    <p><strong>Price:</strong> $${latestPrice.toFixed(2)}</p>
                    <p><strong>Volume:</strong> ${volumes[volumes.length - 1].toLocaleString()}</p>
                    <p><strong>SMA (20):</strong> ${sma[sma.length - 1] ? `$${sma[sma.length - 1].toFixed(2)}` : 'N/A'}</p>
                    ${emaDisplay}
                    <p><strong>RSI (14):</strong> ${latestRsi ? latestRsi.toFixed(2) : 'N/A'}</p>
                    ${atrInfoHTML}
                `;

                renderChart(times, prices, sma, ema8, ema13, ema21, ema34, ema50, rsi, atrLevels);
            } catch (error) {
                document.getElementById('stockData').innerHTML = 'Error fetching data. Check network or API limit.';
                console.error(error);
            }
        }

        // Event listeners
        document.getElementById('smaToggle').addEventListener('change', () => {
            if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema8, dataCache.ema13, dataCache.ema21, dataCache.ema34, dataCache.ema50, dataCache.rsi, dataCache.atrLevels);
        });
        document.getElementById('ema8Toggle').addEventListener('change', () => {
            if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema8, dataCache.ema13, dataCache.ema21, dataCache.ema34, dataCache.ema50, dataCache.rsi, dataCache.atrLevels);
        });
        document.getElementById('ema13Toggle').addEventListener('change', () => {
            if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema8, dataCache.ema13, dataCache.ema21, dataCache.ema34, dataCache.ema50, dataCache.rsi, dataCache.atrLevels);
        });
        document.getElementById('ema21Toggle').addEventListener('change', () => {
            if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema8, dataCache.ema13, dataCache.ema21, dataCache.ema34, dataCache.ema50, dataCache.rsi, dataCache.atrLevels);
        });
        document.getElementById('ema34Toggle').addEventListener('change', () => {
            if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema8, dataCache.ema13, dataCache.ema21, dataCache.ema34, dataCache.ema50, dataCache.rsi, dataCache.atrLevels);
        });
        document.getElementById('ema50Toggle').addEventListener('change', () => {
            if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema8, dataCache.ema13, dataCache.ema21, dataCache.ema34, dataCache.ema50, dataCache.rsi, dataCache.atrLevels);
        });
        document.getElementById('rsiToggle').addEventListener('change', () => {
            if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema8, dataCache.ema13, dataCache.ema21, dataCache.ema34, dataCache.ema50, dataCache.rsi, dataCache.atrLevels);
        });
        document.getElementById('atrToggle').addEventListener('change', () => { if (dataCache) fetchStockData(); }); // Need to re-run to update UI with ATR info

        // Initialize
        updateCallCount();
    </script>
</body>
</html>
