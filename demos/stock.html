<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dakota AI Demos - Real-Time Stock Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        #stockInput { display: block; margin: 20px auto; padding: 10px; width: 200px; }
        #stockData { margin-top: 20px; }
        #toggles { text-align: center; margin: 10px 0; }
        #callCount { color: red; font-weight: bold; }
        #atrInfo { margin-top: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 5px; }
        canvas { display: block; margin: 20px auto; width: 80vw; height: 50vh; max-width: 800px; max-height: 400px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dakota AI Demo: Real-Time Stock Price Tracker</h1>
        <p>This demo showcases our capabilities in real-time data processing, analytics, and visualization. Enter a stock symbol (e.g., AAPL) to fetch real-time data and analyze trends.</p>
        <input type="text" id="stockInput" placeholder="Enter Stock Symbol" value="AAPL">
        <button onclick="fetchStockData()">Fetch Data</button>
        <p id="callCount">API calls today: 0/25</p>
        <div id="toggles">
            <label><input type="checkbox" id="smaToggle" checked> Show SMA</label>
            <label><input type="checkbox" id="emaToggle" checked> Show EMA</label>
            <label><input type="checkbox" id="rsiToggle"> Show RSI</label>
            <label><input type="checkbox" id="atrToggle" checked> Show ATR Levels</label>
            <label><input type="checkbox" id="vpaToggle"> Show VPA</label>
        </div>
        <div id="stockData"></div>
        <canvas id="myChart"></canvas>
    </div>

    <script>
        let chart;
        let dataCache = null;

        function updateCallCount() {
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem('lastCallDate');
            let callsToday = parseInt(localStorage.getItem('callsToday') || 0);
            if (lastDate !== today) {
                callsToday = 0;
                localStorage.setItem('lastCallDate', today);
            }
            document.getElementById('callCount').textContent = `API calls today: ${callsToday}/25`;
            return callsToday;
        }

        function incrementCallCount() {
            const callsToday = updateCallCount() + 1;
            localStorage.setItem('callsToday', callsToday);
            updateCallCount();
        }

        function calculateEMA(prices, period) {
            const multiplier = 2 / (period + 1);
            const ema = [];
            let prev = prices[0];
            for (let i = 0; i < prices.length; i++) {
                prev = (prices[i] - prev) * multiplier + prev;
                ema.push(prev);
            }
            return ema;
        }

        function calculateRSI(prices, period = 14) {
            const gains = [];
            const losses = [];
            for (let i = 1; i < prices.length; i++) {
                const change = prices[i] - prices[i-1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? -change : 0);
            }
            const rsi = [];
            let avgGain = gains.slice(0, period).reduce((a,b)=>a+b,0) / period;
            let avgLoss = losses.slice(0, period).reduce((a,b)=>a+b,0) / period;
            for (let i = 0; i < gains.length; i++) {
                if (i >= period) {
                    avgGain = (avgGain * (period - 1) + gains[i]) / period;
                    avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                }
                const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                rsi.push(100 - (100 / (1 + rs)));
            }
            return Array(period).fill(null).concat(rsi);
        }

        function calculateATR(highs, lows, closes, period = 14) {
            const tr = [];
            for (let i = 0; i < highs.length; i++) {
                if (i === 0) {
                    tr.push(highs[i] - lows[i]);
                } else {
                    const tr1 = highs[i] - lows[i];
                    const tr2 = Math.abs(highs[i] - closes[i-1]);
                    const tr3 = Math.abs(lows[i] - closes[i-1]);
                    tr.push(Math.max(tr1, tr2, tr3));
                }
            }
            const atr = [];
            let sum = tr.slice(0, period).reduce((a, b) => a + b, 0);
            atr.push(sum / period);
            for (let i = period; i < tr.length; i++) {
                atr.push((atr[atr.length - 1] * (period - 1) + tr[i]) / period);
            }
            return atr;
        }

        function calculateATRLevels(previousClose, atr, highs, lows) {
            const range = Math.max(...highs) - Math.min(...lows);
            const trPercentOfATR = range / atr * 100;

            const lowerTrigger = previousClose - 0.236 * atr;
            const upperTrigger = previousClose + 0.236 * atr;

            const levels = {
                previousClose: previousClose,
                lowerTrigger: lowerTrigger,
                upperTrigger: upperTrigger,
                lower0382: previousClose - 0.382 * atr,
                upper0382: previousClose + 0.382 * atr,
                lower0500: previousClose - 0.5 * atr,
                upper0500: previousClose + 0.5 * atr,
                lower0618: previousClose - 0.618 * atr,
                upper0618: previousClose + 0.618 * atr,
                lower0786: previousClose - 0.786 * atr,
                upper0786: previousClose + 0.786 * atr,
                lower1000: previousClose - atr,
                upper1000: previousClose + atr,
                lower1236: previousClose - 1.236 * atr,
                upper1236: previousClose + 1.236 * atr,
                lower1382: previousClose - 1.382 * atr,
                upper1382: previousClose + 1.382 * atr,
                lower1500: previousClose - 1.5 * atr,
                upper1500: previousClose + 1.5 * atr,
                lower1618: previousClose - 1.618 * atr,
                upper1618: previousClose + 1.618 * atr,
                lower1786: previousClose - 1.786 * atr,
                upper1786: previousClose + 1.786 * atr,
                lower2000: previousClose - 2 * atr,
                upper2000: previousClose + 2 * atr
            };

            return { levels, trPercentOfATR, range };
        }

        function determineTrend(price, fastEMA, pivotEMA, slowEMA) {
            const bullish = price >= fastEMA && fastEMA >= pivotEMA && pivotEMA >= slowEMA;
            const bearish = price <= fastEMA && fastEMA <= pivotEMA && pivotEMA <= slowEMA;
            return bullish ? 'Bullish' : bearish ? 'Bearish' : 'Neutral';
        }

        function renderChart(times, prices, sma, ema, rsi, atrLevels, vpaData) {
            const ctx = document.getElementById('myChart');
            const datasets = [{ label: 'Price', data: prices, borderColor: 'blue', fill: false }];
            if (document.getElementById('smaToggle').checked && sma) datasets.push({ label: 'SMA 20', data: sma, borderColor: 'red', fill: false });
            if (document.getElementById('emaToggle').checked && ema) datasets.push({ label: 'EMA 20', data: ema, borderColor: 'green', fill: false });

            // Add ATR levels as horizontal lines
            if (document.getElementById('atrToggle').checked && atrLevels) {
                const chartLength = prices.length;
                datasets.push({
                    label: 'Previous Close',
                    data: new Array(chartLength).fill(atrLevels.previousClose),
                    borderColor: 'white',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                });
                datasets.push({
                    label: 'Lower Trigger',
                    data: new Array(chartLength).fill(atrLevels.lowerTrigger),
                    borderColor: 'yellow',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                });
                datasets.push({
                    label: 'Upper Trigger',
                    data: new Array(chartLength).fill(atrLevels.upperTrigger),
                    borderColor: 'aqua',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                });
                datasets.push({
                    label: 'ATR -1',
                    data: new Array(chartLength).fill(atrLevels.lower1000),
                    borderColor: 'white',
                    borderDash: [10, 5],
                    pointRadius: 0,
                    fill: false
                });
                datasets.push({
                    label: 'ATR +1',
                    data: new Array(chartLength).fill(atrLevels.upper1000),
                    borderColor: 'white',
                    borderDash: [10, 5],
                    pointRadius: 0,
                    fill: false
                });
            }

            // Add VPA data if available
            if (document.getElementById('vpaToggle').checked && vpaData && vpaData.boxes) {
                vpaData.boxes.forEach(box => {
                    datasets.push(box);
                });
            }

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: times.map(t => new Date(t).toLocaleTimeString()), datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    if (rsi && rsi[context.dataIndex]) {
                                        return 'RSI: ' + rsi[context.dataIndex].toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        async function fetchStockData() {
            let callsToday = updateCallCount();
            if (callsToday >= 25) {
                document.getElementById('stockData').innerHTML = 'Daily API limit reached (25 calls). Try again tomorrow.';
                return;
            }

            const symbol = document.getElementById('stockInput').value.toUpperCase();
            const apiKey = '1KVB3JGWTYYBEYDS'; // Note: This should be kept secret; move to server-side for production
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=${symbol}&interval=5min&apikey=${apiKey}`;

            try {
                document.getElementById('stockData').innerHTML = 'Fetching data...';
                const response = await axios.get(url);
                const data = response.data['Time Series (5min)'];
                incrementCallCount();

                if (!data) {
                    document.getElementById('stockData').innerHTML = 'Invalid symbol or API error.';
                    return;
                }

                const times = Object.keys(data).reverse();
                const opens = times.map(time => parseFloat(data[time]['1. open']));
                const highs = times.map(time => parseFloat(data[time]['2. high']));
                const lows = times.map(time => parseFloat(data[time]['3. low']));
                const closes = times.map(time => parseFloat(data[time]['4. close']));
                const volumes = times.map(time => parseFloat(data[time]['5. volume']));
                const prices = opens; // Using opens as primary price

                // Calculations
                const sma = prices.map((price, index) => {
                    if (index < 19) return null;
                    const sum = prices.slice(index - 19, index + 1).reduce((a, b) => a + b, 0);
                    return sum / 20;
                });
                const ema = calculateEMA(prices, 20);
                const rsi = calculateRSI(closes, 14);
                const atr = calculateATR(highs, lows, closes, 14);
                const previousClose = closes[closes.length - 1];
                const latestATR = atr[atr.length - 1];
                const { levels: atrLevels, trPercentOfATR, range } = calculateATRLevels(previousClose, latestATR, highs, lows);

                // Trend calculation
                const fastEMA8 = calculateEMA(closes, 8);
                const pivotEMA21 = calculateEMA(closes, 21);
                const slowEMA34 = calculateEMA(closes, 34);
                const trend = determineTrend(closes[closes.length - 1], fastEMA8[fastEMA8.length - 1], pivotEMA21[pivotEMA21.length - 1], slowEMA34[slowEMA34.length - 1]);

                dataCache = { times, prices, sma, ema, rsi, atr, atrLevels, trPercentOfATR, range, trend, highs, lows, closes, volumes };

                // Update UI
                const latestPrice = prices[prices.length - 1];
                const latestTime = times[times.length - 1];
                const latestRsi = rsi[rsi.length - 1];

                let atrInfoHTML = '';
                if (document.getElementById('atrToggle').checked) {
                    const trColor = trPercentOfATR <= 70 ? 'green' : trPercentOfATR >= 90 ? 'red' : 'orange';
                    atrInfoHTML = `
                        <div id="atrInfo">
                            <h3>Saty ATR Levels</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="background-color: ${trend === 'Bullish' ? '#d4edda' : trend === 'Bearish' ? '#f8d7da' : '#fff3cd'};">
                                    <td><strong>Trend:</strong> ${trend}</td>
                                    <td><strong>Range ($${range.toFixed(2)}) is ${trPercentOfATR.toFixed(1)}% of ATR ($${latestATR.toFixed(2)})</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Calls > $${atrLevels.upperTrigger.toFixed(2)}</strong></td>
                                    <td><strong>+1 ATR: $${atrLevels.upper1000.toFixed(2)}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Puts < $${atrLevels.lowerTrigger.toFixed(2)}</strong></td>
                                    <td><strong>-1 ATR: $${atrLevels.lower1000.toFixed(2)}</strong></td>
                                </tr>
                            </table>
                        </div>
                    `;
                }

                document.getElementById('stockData').innerHTML = `
                    <h2>${symbol} - Latest Data</h2>
                    <p><strong>Time:</strong> ${latestTime}</p>
                    <p><strong>Price:</strong> $${latestPrice.toFixed(2)}</p>
                    <p><strong>Volume:</strong> ${volumes[volumes.length - 1].toLocaleString()}</p>
                    <p><strong>SMA (20):</strong> ${sma[sma.length - 1] ? `$${sma[sma.length - 1].toFixed(2)}` : 'N/A'}</p>
                    <p><strong>EMA (20):</strong> $${ema[ema.length - 1].toFixed(2)}</p>
                    <p><strong>RSI (14):</strong> ${latestRsi ? latestRsi.toFixed(2) : 'N/A'}</p>
                    ${atrInfoHTML}
                `;

                renderChart(times, prices, sma, ema, rsi, atrLevels);
            } catch (error) {
                document.getElementById('stockData').innerHTML = 'Error fetching data. Check network or API limit.';
                console.error(error);
            }
        }

        // Event listeners
        document.getElementById('smaToggle').addEventListener('change', () => { if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema, dataCache.rsi, dataCache.atrLevels); });
        document.getElementById('emaToggle').addEventListener('change', () => { if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema, dataCache.rsi, dataCache.atrLevels); });
        document.getElementById('rsiToggle').addEventListener('change', () => { if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema, dataCache.rsi, dataCache.atrLevels); });
        document.getElementById('atrToggle').addEventListener('change', () => { if (dataCache) fetchStockData(); }); // Need to re-run to update UI with ATR info
        document.getElementById('vpaToggle').addEventListener('change', () => { if (dataCache) renderChart(dataCache.times, dataCache.prices, dataCache.sma, dataCache.ema, dataCache.rsi, dataCache.atrLevels); });

        // Initialize
        updateCallCount();
    </script>
</body>
</html>
